<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
  <script src="http://code.jquery.com/jquery.js"></script>
  <script src="bootstrap/js/bootstrap.min.js"></script>

  <script>
    var Job = function() {
      var gaussRandom = function () {
         var u = 2 * Math.random() - 1;
         var v = 2 * Math.random() - 1;
         var r = u * u + v * v;
         if (r == 0 || r > 1) return gaussRandom();
         var c = Math.sqrt(-2 * Math.log(r) / r);
         return u * c;
      }
      this.processTime = gaussRandom() + 10.0;

      this.execute = function(onComplete) {
        return setTimeout(function() { onComplete() } , this.processTime * 100);
      };
      return this;
    };

    var Worker = function(workerId) {
      this.workerId = workerId;
      this.jobs = [];
      this.MAX_JOBS = 10;

      this.idle = function() {
        return (this.jobs.length == 0);
      };

      this.pullJobs = function() {
        var worker = this;
        if (this.jobs[0]) {
          var id = this.jobs[0].execute(function() {
            worker.jobs.shift();

            console.log("Job[" + id + "] Completed.");
            var percent = (worker.jobs.length / worker.MAX_JOBS) * 100;
            $('#' + worker.workerId).css('width',  percent + '%');

            worker.pullJobs();
          });
        }
      };

      this.addJob = function(job) {
        if (this.idle()) {
          this.jobs.push(job);
          this.pullJobs();
        } else {
          this.jobs.push(job);
        }
      };

      return this;
    }

    var WorkersPool = function() {
      this.MAX_WORKERS = 10;
      this.workers = [];
      for (var i = 0; i < this.MAX_WORKERS; i++) {
        var workerId = "worker_" + i;
        this.workers.push(new Worker(workerId));
      }

      this.addJob = function(job) {
        for (var k = 0; k < this.MAX_WORKERS; k++) {
          if ( this.workers[k].idle() ){
            this.workers[k].addJob(job);
            return;
          }
        }
        var j = Math.floor(Math.random() * this.MAX_WORKERS);
        this.workers[j].addJob(job);
      };

      return this;
    };

    var pool = new WorkersPool();
    function onLoad() {
      pool.workers.forEach(function(worker) {
        var progressBar = '<div class="progress progress-info progress-striped"><div id="' + worker.workerId + '" class="bar" style="width:0%"></div></div>';
        $('#sim_bars').append(progressBar);
      });
    }

    function createJobs() {
      for(var i = 0; i < 20; i++) { pool.addJob(new Job()); }
    }
  </script>
</head>
<body onLoad="onLoad()">
  <div class="container">
    <p>
      <button class="btn btn-large btn-primary" type="button" onClick="createJobs()">Create Jobs</button>
    </p>
    <div id="sim_bars" style="width:400px"></div>
  </div>
</body>
</html>