<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
  <script src="http://code.jquery.com/jquery.js"></script>
  <script src="bootstrap/js/bootstrap.min.js"></script>

  <link href="rickshaw/rickshaw.min.css" rel="stylesheet">
  <script src="rickshaw/vendor/d3.v2.js"></script>
  <script src="rickshaw/rickshaw.min.js"></script>

  <script>
    var Job = function() {
      var gaussRandom = function () {
         var u = 2 * Math.random() - 1;
         var v = 2 * Math.random() - 1;
         var r = u * u + v * v;
         if (r == 0 || r > 1) return gaussRandom();
         var c = Math.sqrt(-2 * Math.log(r) / r);
         return u * c;
      }
      this.processTime = (gaussRandom() * 0.0) + 120.0;
      this.startTime = (new Date()).getTime();
      this.endTime = null;
      this.execute = function(onComplete) {
        var job = this;
        return setTimeout(function() {
          job.endTime = (new Date()).getTime();
          var totalTime =  job.endTime - job.startTime;
          onComplete(totalTime);
        }, this.processTime);
      };
      return this;
    };

    var Worker = function(workerId) {
      this.workerId = workerId;
      this.jobs = [];
      this.MAX_JOBS = 10;

      this.totalTime = 0;
      this.totalTime2 = 0;
      this.numJobs = 0;

      this.idle = function() {
        return (this.jobs.length == 0);
      };

      this.pullJobs = function() {
        var worker = this;
        if (this.jobs[0]) {
          var id = this.jobs[0].execute(function(totalTime) {
            worker.jobs.shift();
            worker.totalTime += totalTime;
            worker.totalTime2 += totalTime * totalTime;
            worker.numJobs += 1;

            // console.log("Job[" + id + "] Completed.");
            var percent = (worker.jobs.length / worker.MAX_JOBS) * 100;
            $('#' + worker.workerId).css('width',  percent + '%');

            worker.pullJobs();
          });
        }
      };

      this.addJob = function(job) {
        if (this.idle()) {
          this.jobs.push(job);
          this.pullJobs();
        } else {
          this.jobs.push(job);
        }
      };
      return this;
    }

    var Summary = function(numJobs, totalTime, totalTime2) {
      this.numJobs = numJobs;
      this.totalTime = totalTime;
      this.totalTime2 = totalTime2;
      this.average =  function() {
        if (this.numJobs > 0) {
          return this.totalTime / this.numJobs;
        }
        return 0;
      };

      this.standardDeviation = function() {
        if (this.average() > 0) {
          return Math.sqrt(this.totalTime2 / this.numJobs - (this.average() * this.average()));
        }
        return 0;
      };
    }

    var WorkersPool = function() {
      this.MAX_WORKERS = 35;
      this.workers = [];

      for (var i = 0; i < this.MAX_WORKERS; i++) {
        var workerId = "worker_" + i;
        this.workers.push(new Worker(workerId));
      }

      this.nextW = 0;
      this.nextWorker = function() {
        if (this.nextW < this.MAX_WORKERS - 1) {
          this.nextW = this.nextW + 1;
        } else {
          this.nextW = 0;
        }
        return this.nextW;
      };

      this.addJob = function(job) {
        // for (var k = 0; k < this.MAX_WORKERS; k++) {
        //   if ( this.workers[k].idle() ){
        //     this.workers[k].addJob(job);
        //     return;
        //   }
        // }
        // var j = Math.floor(Math.random() * this.MAX_WORKERS);
        // this.workers[j].addJob(job);
        var l = this.nextWorker();
        this.workers[l].addJob(job);
      };

      this.totalTime = 0;
      this.totalTime2 = 0;
      this.numJobs = 0;

      this.summarize = function() {
        for( var i = 0; i < this.MAX_WORKERS; i++ ) {
          this.totalTime += this.workers[i].totalTime;
          this.totalTime2 += this.workers[i].totalTime2;
          this.numJobs += this.workers[i].numJobs;
        }
        return(new Summary(this.numJobs, this.totalTime, this.totalTime2));
      };

      return this;
    };

    function createGraph() {
      var palette = new Rickshaw.Color.Palette();
      var graph = new Rickshaw.Graph ( {
        element: document.querySelector("#chart"),
        renderer: 'line',
        width: 550,
        height: 250,
        series: [ {
          name: 'Average',
          color: palette.color(),
          data: [ { x: 0, y: 0 } ]
        }, {
          name: 'Standard deviation',
          color: palette.color(),
          data: [ { x: 0, y: 0 } ]
        } ]
      });
      var yAxis = new Rickshaw.Graph.Axis.Y ({ graph: graph });
      var xAxis = new Rickshaw.Graph.Axis.X ({ graph: graph });
      var legend = new Rickshaw.Graph.Legend({
        element: document.querySelector('#legend'),
        graph: graph
      });
      return graph;
    }

    var pool = new WorkersPool();
    function onLoad() {
      pool.workers.forEach(function(worker) {
        var progressBar = '<div class="progress progress-info progress-striped"><div id="' + worker.workerId + '" class="bar" style="width:0%"></div></div>';
        $('#sim_bars').append(progressBar);
      });
    }

    function createJobs() {
      setInterval(function() {
        for(var i = 0; i < 25; i++) { pool.addJob(new Job()); }
      }, 100);

      var graph = createGraph();
      graph.render();

      var i = 0;
      var summary = null;
      var lastSummary = null;
      setInterval(function(){
        summary = pool.summarize();
        if (lastSummary) {
          var diffSummary = new Summary(summary.numJobs - lastSummary.numJobs,
            summary.totalTime - lastSummary.totalTime,
            summary.totalTime2 - lastSummary.totalTime2
          );
          $('#pAvg').val(diffSummary.average());
          $('#pStd').val(diffSummary.standardDeviation());

          graph.series[0].data.push({ x: i, y: diffSummary.average() });
          graph.series[1].data.push({ x: i, y: diffSummary.standardDeviation() });
          graph.update();
          i++;
        }
        $('#jobs').val(summary.numJobs);
        $('#avg').val(summary.average());
        $('#std').val(summary.standardDeviation());
        lastSummary = summary;
      }, 1000);
    }
  </script>
</head>
<body onLoad="onLoad()">
  <div class="container">
    <p>
      <button class="btn btn-large btn-primary" type="button" onClick="createJobs()">Create Jobs</button>
    </p>
    <input id="pAvg" type="text" class="input-small" placeholder="avg">
    <input id="pStd" type="text" class="input-small" placeholder="std"><br>
    <input id="avg" type="text" class="input-small" placeholder="avg">
    <input id="std" type="text" class="input-small" placeholder="std">
    <input id="jobs" type="text" class="input-small" placeholder="num jobs">
    <div id="chart_container">
      <div id="chart"></div>
    </div>
    <div id="legend"></div><br>
    <div id="sim_bars" style="width:400px"></div>
  </div>
</body>
</html>
