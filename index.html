<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
  <script src="http://code.jquery.com/jquery.js"></script>
  <script src="bootstrap/js/bootstrap.min.js"></script>

  <script>
    var Job = function() {
      var gaussRandom = function () {
         var u = 2 * Math.random() - 1;
         var v = 2 * Math.random() - 1;
         var r = u * u + v * v;
         if (r == 0 || r > 1) return gaussRandom();
         var c = Math.sqrt(-2 * Math.log(r) / r);
         return u * c;
      }
      this.processTime = (gaussRandom() * 30.0) + 120.0;
      this.startTime = (new Date()).getTime();
      this.endTime = null;
      this.execute = function(onComplete) {
        var job = this;
        return setTimeout(function() {
          job.endTime = (new Date()).getTime();
          var totalTime =  job.endTime - job.startTime;
          onComplete(totalTime);
        }, this.processTime);
      };
      return this;
    };

    var Worker = function(workerId) {
      this.workerId = workerId;
      this.jobs = [];
      this.MAX_JOBS = 10;

      this.totalTime = 0;
      this.totalTime2 = 0;
      this.numJobs = 0;

      this.idle = function() {
        return (this.jobs.length == 0);
      };

      this.pullJobs = function() {
        var worker = this;
        if (this.jobs[0]) {
          var id = this.jobs[0].execute(function(totalTime) {
            worker.jobs.shift();
            worker.totalTime += totalTime;
            worker.totalTime2 += totalTime * totalTime;
            worker.numJobs += 1;

            // console.log("Job[" + id + "] Completed.");
            var percent = (worker.jobs.length / worker.MAX_JOBS) * 100;
            $('#' + worker.workerId).css('width',  percent + '%');

            worker.pullJobs();
          });
        }
      };

      this.addJob = function(job) {
        if (this.idle()) {
          this.jobs.push(job);
          this.pullJobs();
        } else {
          this.jobs.push(job);
        }
      };

      return this;
    }

    var WorkersPool = function() {
      this.MAX_WORKERS = 35;
      this.workers = [];

      for (var i = 0; i < this.MAX_WORKERS; i++) {
        var workerId = "worker_" + i;
        this.workers.push(new Worker(workerId));
      }

      this.nextW = 0;
      this.nextWorker = function() {
        if (this.nextW < this.MAX_WORKERS - 1) {
          this.nextW = this.nextW + 1;
        } else {
          this.nextW = 0;
        }
        return this.nextW;
      };

      this.addJob = function(job) {
        // for (var k = 0; k < this.MAX_WORKERS; k++) {
        //   if ( this.workers[k].idle() ){
        //     this.workers[k].addJob(job);
        //     return;
        //   }
        // }
        var j = Math.floor(Math.random() * this.MAX_WORKERS);
        this.workers[j].addJob(job);
        // var l = this.nextWorker();
        // this.workers[l].addJob(job);
      };

      this.totalTime = 0;
      this.totalTime2 = 0;
      this.numJobs = 0;

      this.summarize = function() {
        for( var i = 0; i < this.MAX_WORKERS; i++ ) {
          this.totalTime += this.workers[i].totalTime;
          this.totalTime2 += this.workers[i].totalTime2;
          this.numJobs += this.workers[i].numJobs;
        }
      };

      this.avg = function() {
        if ( this.numJobs ) {
          return this.totalTime / this.numJobs;
        }
        return 0;
      };

      this.std = function() {
        return Math.sqrt(this.totalTime2 / this.numJobs - (this.avg() * this.avg()));
      };

      return this;
    };

    var pool = new WorkersPool();
    function onLoad() {
      pool.workers.forEach(function(worker) {
        var progressBar = '<div class="progress progress-info progress-striped"><div id="' + worker.workerId + '" class="bar" style="width:0%"></div></div>';
        $('#sim_bars').append(progressBar);
      });
    }

    function createJobs() {
      setInterval(function() {
        pool.summarize();
        $('#jobs').val(pool.numJobs);
        $('#avg').val(pool.avg());
        $('#std').val(pool.std());
        for(var i = 0; i < 25; i++) { pool.addJob(new Job()); }
      }, 100);
    }
  </script>
</head>
<body onLoad="onLoad()">
  <div class="container">
    <p>
      <button class="btn btn-large btn-primary" type="button" onClick="createJobs()">Create Jobs</button>
    </p>
    <div id="sim_bars" style="width:400px"></div>
    <input id="jobs" type="text" class="input-small" placeholder="num jobs">
    <input id="avg" type="text" class="input-small" placeholder="avg">
    <input id="std" type="text" class="input-small" placeholder="std">
  </div>
</body>
</html>