<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
  <link href="sim.css" rel="stylesheet">

  <script src="http://code.jquery.com/jquery.js"></script>
  <script src="lib/bootstrap/js/bootstrap.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="span4">
        <button id="create-jobs" class="btn btn-large btn-primary" type="button">Create Jobs</button>
      </div>
      <div class="span8">
        <div id="workers"></div>
      </div>
    </div>
  </div>
</body>

<script>
  $(function() {
    var Job = function(li) {
      this.domElement = li;
      this.requestTime = this.domElement.data('request-time');

      var gaussRandom = function () {
         var u = 2 * Math.random() - 1;
         var v = 2 * Math.random() - 1;
         var r = u * u + v * v;
         if (r == 0 || r > 1) return gaussRandom();
         var c = Math.sqrt(-2 * Math.log(r) / r);
         return u * c;
      }

      this.processTime = function() {
        return (gaussRandom() * 50.0) + 400.0;
      }

      this.execute = function() {
        var job = this;
        return setTimeout(function() {
          job.domElement.parent().trigger('job-finished', { job: job });
        }, this.processTime());
      }
      return this;
    };

    var MeanLatency = function(numJobs, totalTime) {
      this.numJobs = numJobs;
      this.totalTime = totalTime;
      this.totalTime2 = totalTime * totalTime;

      this.average =  function() {
        if (this.numJobs > 0) {
          return this.totalTime / this.numJobs;
        }
        return 0;
      };

      this.standardDeviation = function() {
        var avg = this.average();
        if (avg > 0) {
          return Math.sqrt(this.totalTime2 / this.numJobs - (avg * avg));
        }
        return 0;
      };
    }


    var WorkerPool = function(options) {
      var MAX_WORKERS = 20;

      this.workers = $('#workers');
      for (var i = 0; i < MAX_WORKERS; i++) {
        var ul = $('<ul class="worker-queue well"></ul>');
        this.workers.append(ul);

        ul.on('job-added', function(e, params) {
          var jobs = $(this).children();
          if (jobs.length === 1) {
            var newJob = new Job(jobs.first());
            newJob.execute();
          }
        });

        ul.on('job-finished', function(e, params) {
          params['job'].domElement.remove();
          var jobs = $(this).children();
          if (jobs.length > 0) {
            var newJob = new Job(jobs.first());
            newJob.execute();
          }
        });
      }

      var RoundRobinStrategy = function(workers) {
        var i = 0;

        var inc = function() {
          i = (i < workers.length - 1) ? i + 1: 0;
        }

        this.addJob = function(li) {
          $(workers[i]).append(li).fadeIn(1000);
          $(workers[i]).trigger('job-added');
          inc();
        };

        return this;
      };

      this.strategy = new RoundRobinStrategy(this.workers.children());
      this.addJob = function() {
        var requestTime = (new Date()).getTime();
        var li = $('<li class="job" data-request-time="' + requestTime + '">.</li>');
        this.strategy.addJob(li);
      };

      return this;
    };

    var pool = new WorkerPool();

    $('#create-jobs').on('click', function() {
      var CONCURRENT_JOBS = 400;
      for(var i = 0; i < CONCURRENT_JOBS; i++) {
        pool.addJob();
      }
    });
  });
</script>

</html>
